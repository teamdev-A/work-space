<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>テトリス</title>
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body onload="init()">
  <div id="container">
    <canvas id="cvs"></canvas>
  </div>
  <script>
    // JavaScriptコードをここに配置
    const speed = 300;
    // ブロック1マスの大きさ
    const blockSize = 30;
    // ボードサイズ
    const boardRow = 20;
    const boardCol = 10;
    // キャンバスの取得
    const cvs = document.getElementById("cvs");
    // 2dコンテキストを取得
    const ctx = cvs.getContext("2d");
    // キャンバスサイズ
    const canvasW = blockSize * boardCol;
    const canvasH = blockSize * boardRow;
    cvs.width = canvasW;
    cvs.height = canvasH;
    // コンテナの設定
    const container = document.getElementById("container");
    container.style.width = canvasW + 'px';

    const tetSize=4;
    //T型のtet
    let tet= [
          [0, 0, 0, 0],
          [0, 1, 0, 0],
          [1, 1, 1, 0],
          [0, 0, 0, 0],
        ];

    let offsetX = 0;
    let offsetY = 0;

    const board = [];

    let timerId = NaN;

    // 描画処理
    const draw = () => {
      // 塗りに黒を設定
      ctx.fillStyle = '#000';
      // キャンバスを塗りつぶす
      ctx.fillRect(0, 0, canvasW, canvasH);

      //塗りに赤を設定
      ctx.fillStyle="#f00";
      //x座標150,y座標150の場所に幅30,縦30の四角を描画
      ctx.fillRect(150,150,blockSize,blockSize);

      for (let y = 0; y < boardRow; y++) {
        for (let x = 0; x < boardCol; x++) {
          if (board[y][x]) {
            drawBlock(x, y);
          }
        }
      }

      //テトリミノの描画
      for (let y = 0; y < tetSize; y++) {
          for (let x = 0; x < tetSize; x++) {
            //もし、1だったら
            if (tet[y][x]) {
              //四角を描画
              drawBlock(offsetX+x,offsetY+y);
            }
          }
        }
      }

      const drawBlock = (x, y) => {
        let px = x * blockSize;
        let py = y * blockSize;
        //塗りを設定
        ctx.fillStyle = '#f00';
        ctx.fillRect(px, py, blockSize, blockSize);
        //線を設定
        ctx.strokeStyle = 'black';
        //線を描画
        ctx.strokeRect(px, py, blockSize, blockSize);
      };

      const canMove = (dx, dy, nowTet = tet) => {
        for (let y = 0; y < tetSize; y++) {
          for (let x = 0; x < tetSize; x++) {
            //その場所にブロックがあれば
            if (nowTet[y][x]) {
              //ボード座標に変換
              let nx = offsetX + x + dx;
              let ny = offsetY + y + dy;
              if (
                //調査する座標がボード外だったらできない
                ny < 0 ||
                nx < 0 ||
                ny >= boardRow ||
                nx >= boardCol ||
                //移動したいボード上の場所にすでに存在してたらできない
                board[ny][nx]
              ) {
                //移動できない
                return false;
              }
            }
          }
        }
        //移動できる
        return true;
      };

      const createRotateTet = () => {
        //新しいtetを作る
        let newTet = [];
        for (let y = 0; y < tetSize; y++) {
          newTet[y] = [];
          for (let x = 0; x < tetSize; x++) {
            //時計回りに90度回転させる
            newTet[y][x] = tet[tetSize - 1 - x][y];
          }
        }
        return newTet;
      };


      document.onkeydown = (e) =>{
          switch (e.keyCode) {
            case 37: //左
              if (canMove(-1, 0)) offsetX--;
              break;
            case 38: //上
              if (canMove(0, -1)) offsetY--;
              break;
            case 39: //右
              if (canMove(1, 0)) offsetX++;
              break;
            case 40: //下
              if (canMove(0, 1)) offsetY++;
              break;
            case 32: //space
              let newTet = createRotateTet();
              if(canMove(0, 0, newTet)){
                tet = newTet;
              }
          }
          draw();
      };

      const dropTet = () => {
        //下に行けたら
        if (canMove(0, 1)) {
          //下に行く
          offsetY++;
        } else {
        }
        draw();
      };


      const initStartPos = () => {
        offsetX = boardCol / 2 - tetSize / 2;
        offsetY = 0;
      }

      // 初期化処理
      const init = () => {
        for (let y = 0; y < boardRow; y++) {
          board[y] = [];
          for (let x = 0; x < boardCol; x++) {
            board[y][x] = 0;
          }
        }

        initStartPos();
        timerId = setInterval(dropTet, speed)

        draw();
      };
    </script>
  </body>
</html>
